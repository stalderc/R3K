DROP FUNCTION ACCOUNT_CREATE;
DROP FUNCTION AUTHENTICATE;

CREATE OR REPLACE
  FUNCTION ACCOUNT_CREATE(
      EMAIL    IN VARCHAR2,
      PASSWORD IN VARCHAR2)
    RETURN BOOLEAN
  AS
    EMAIL_CHECK USERS.EMAIL_ADDRESS%TYPE;
    PASSWORD_HASH PASSWORDS.PASSWORD%TYPE;
    CURSOR DATA_PULL
    IS
      SELECT EMAIL_ADDRESS FROM USERS WHERE EMAIL_ADDRESS = EMAIL;
  BEGIN
    SELECT ORA_HASH(PASSWORD) INTO PASSWORD_HASH FROM DUAL;
    OPEN DATA_PULL;
    FETCH DATA_PULL INTO EMAIL_CHECK;
    IF DATA_PULL%NOTFOUND THEN
      INSERT
      INTO USERS
        (
          EMAIL_ADDRESS,
          ACCOUNT_TYPE,
          RESUMATOR_ID
        )
        VALUES
        (
          UPPER(EMAIL),
          'R',
          RES_ID_SEQ.NEXTVAL
        );
      INSERT
      INTO PASSWORDS
        (
          EMAIL_ADD,
          PASSWORD,
          RESUMATOR_ID
        )
        VALUES
        (
          UPPER(EMAIL),
          PASSWORD_HASH,
          RES_ID_SEQ.CURRVAL
        );
      RETURN TRUE;
    ELSE
      RETURN FALSE;
    END IF;
    CLOSE DATA_PULL;
  EXCEPTION
  WHEN OTHERS THEN
    RAISE_APPLICATION_ERROR(-20001,'An error was encountered - '||SQLCODE||' -ERROR- '||SQLERRM);
  END;

  CREATE OR REPLACE
  FUNCTION AUTHENTICATE(
      EMAIL    IN VARCHAR2,
      PASSWORD IN VARCHAR2)
    RETURN BOOLEAN
  IS
    PASSWORD_HASH PASSWORDS.PASSWORD%TYPE;
    PASSWORD_CHECK PASSWORDS.PASSWORD%TYPE;
    CURSOR DATA_PULL
    IS
      SELECT PASSWORD FROM PASSWORDS WHERE EMAIL_ADD = UPPER(EMAIL);
  BEGIN
    OPEN DATA_PULL;
    FETCH DATA_PULL INTO PASSWORD_CHECK;
    IF DATA_PULL%NOTFOUND THEN
      RETURN FALSE;
    END IF;
    CLOSE DATA_PULL;
    SELECT ORA_HASH(PASSWORD) INTO PASSWORD_HASH FROM DUAL;
    IF PASSWORD_HASH != PASSWORD_CHECK THEN
      RETURN FALSE;
    ELSE
      RETURN TRUE;
    END IF;
  EXCEPTION
  WHEN OTHERS THEN
    raise_application_error(-20001,'An error was encountered - '||SQLCODE||' -ERROR- '||SQLERRM);
  END;